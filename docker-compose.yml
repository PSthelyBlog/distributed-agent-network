version: '3.8'

services:
  # Main Orchestrator - routes tasks and spawns domain containers
  main-orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: main-orchestrator
    hostname: main-orchestrator
    volumes:
      # Agent configuration
      - ./agents/main-orchestrator:/agent-config:ro
      # Shared workspace for all agents
      - ./workspace:/workspace
      # Docker socket for spawning domain containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Domain templates for spawning
      - ./agents/domain-templates:/domain-templates:ro
      # Library code (mounted for development)
      - ./lib:/app/lib:ro
    environment:
      - AGENT_ROLE=main
      - AGENT_ID=main-orchestrator
      - REDIS_URL=redis://message-broker:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PYTHONPATH=/app
    depends_on:
      message-broker:
        condition: service_healthy
    networks:
      - agent-network
    restart: unless-stopped
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'

  # Redis Message Broker - handles inter-agent communication
  message-broker:
    image: redis:7-alpine
    container_name: message-broker
    hostname: message-broker
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - agent-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  # Backend Domain Orchestrator
  backend-domain:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: backend-domain
    hostname: backend-domain
    volumes:
      - ./agents/domain-templates/backend:/agent-config:ro
      - ./workspace:/workspace
      - ./lib:/app/lib:ro
    environment:
      - AGENT_ROLE=domain
      - AGENT_ID=backend-domain
      - DOMAIN_TYPE=backend
      - REDIS_URL=redis://message-broker:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PYTHONPATH=/app
    depends_on:
      message-broker:
        condition: service_healthy
    networks:
      - agent-network
    restart: unless-stopped
    profiles:
      - backend
      - domains
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'

  # Frontend Domain Orchestrator
  frontend-domain:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: frontend-domain
    hostname: frontend-domain
    volumes:
      - ./agents/domain-templates/frontend:/agent-config:ro
      - ./workspace:/workspace
      - ./lib:/app/lib:ro
    environment:
      - AGENT_ROLE=domain
      - AGENT_ID=frontend-domain
      - DOMAIN_TYPE=frontend
      - REDIS_URL=redis://message-broker:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PYTHONPATH=/app
    depends_on:
      message-broker:
        condition: service_healthy
    networks:
      - agent-network
    restart: unless-stopped
    profiles:
      - frontend
      - domains
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'

  # DevOps Domain Orchestrator
  devops-domain:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: devops-domain
    hostname: devops-domain
    volumes:
      - ./agents/domain-templates/devops:/agent-config:ro
      - ./workspace:/workspace
      - ./lib:/app/lib:ro
    environment:
      - AGENT_ROLE=domain
      - AGENT_ID=devops-domain
      - DOMAIN_TYPE=devops
      - REDIS_URL=redis://message-broker:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PYTHONPATH=/app
    depends_on:
      message-broker:
        condition: service_healthy
    networks:
      - agent-network
    restart: unless-stopped
    profiles:
      - devops
      - domains
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'

  # Redis Commander - Web UI for debugging Redis (optional)
  redis-ui:
    image: rediscommander/redis-commander:latest
    container_name: redis-ui
    hostname: redis-ui
    environment:
      - REDIS_HOSTS=local:message-broker:6379
    ports:
      - "8081:8081"
    depends_on:
      message-broker:
        condition: service_healthy
    networks:
      - agent-network
    restart: unless-stopped
    profiles:
      - debug

# Named volumes
volumes:
  redis-data:
    driver: local

# Network configuration
networks:
  agent-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
